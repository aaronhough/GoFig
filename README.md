# GoFig
GoFig is a tool for managing Firestore database migrations. This project aims to achieve the following:
1. The end user will have visibility into all pending migration changes and effects in relation to the active state of their database. The user can then decide to push or cancel the migration.
2. When a migration is pushed to the database, all the changes presented to the end user are implemented and no other changes/effects are implemented by the migrator.
3. All changes made by the migrator in a migration job can be completely reversed by staging and pushing the generated `_rollback` migration file.

## Install
```
go get github.com/aaronhough/GoFig
```
## Initialize Migrator
The migrator is initialized with a few configuration parameters.
```go
import fig "github.com/aaronhough/GoFig"

config := fig.Config{
    // The location of your admin key file.
    KeyPath: "~/project/.keys/my-admin-key.json",
    // The location to load/store migration files.
    StoragePath: "~/project/storage",
    // A unique name for this migration.
    Name: "my-migration",
}

fg, err := fig.New(config)

defer fg.Close()
```

## Stage a New Migration
Stage each change into the migrator using the `Stage` utility.
```go
// Sample data.
data := map[string]any{
    "foo": "bar",
    "fiz": false,
    "buz": map[string]any{
        "a": []any{ 2, 2, 3 },
    },
}

// Stage options are Add, Update, Set, and Delete.
fg.Stage().Add("fig/fog", data)
fg.Stage().Update("foo/bar", map[string]any{ "hello": "world" })
```

## Save a Migration To Storage
Save a staged migration to storage then load and run it at a later time.
```Go
// A new file is saved to `StoragePath` folder.
fg.StoreMigration()
```

## Load an Existing Migration
The migrator will search for an existing migration file in the `StoragePath` folder that matches the configured `Name`.
```go
// If a file matching the migration `Name` exists,
// it will be loaded.
fg.LoadFromFile()
```
## Run a Migration
The interactive migration shell will present the changes and prompt for confirmation. On confirmation, the changes will be executed against the database and a rollback migration file will be saved to the `StoragePath` folder.
```go
// Launch the interactive shell.
fg.ManageStagedMigration()
```

## Rollback
Locate the `_rollback` file generated by the target migration job. Ensure the migration config matches the name of the rollback file. Load and run the migration.
```go
config := fig.Config{
    KeyPath: "~/project/.keys/my-admin-key.json",
    StoragePath: "~/project/storage",
    // File expected at ~/project/storage/my-migration_rollback.json
    Name: "my-migration_rollback",
}

fg, err := fig.New(config)
defer fg.Close()

fg.LoadFromFile()
fg.ManageStagedMigration()
```

## Complex types
Note some examples of supported complex types.
```go
data := map[string]any{
    // Represent a document reference object.
    "ref": fg.RefField("fig/fog"),
    // Time objects are handled normally.
    "time": time.Now(),
    // Safely marks a key for deletion.
    "prev": fg.DeleteField(),
}
```

## To Do
- Option to save diff
- Abbreviate large diffs in strategic ways